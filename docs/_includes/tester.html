<script src="../js/Main.js"></script>
<link rel="stylesheet" type="text/css" href="css/tester.css">

<!-- Code Mirror CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.css" integrity="sha256-vZ3SaLOjnKO/gGvcUWegySoDU6ff33CS5i9ot8J9Czk=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.js" integrity="sha256-C1kVf8tUtnM4eBSZM0mE7kcDrTYuVGxACdyYvhMEeRo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/mode/clojure/clojure.min.js" integrity="sha256-rdlGcdCWKSU7f61JkJGn29gSD+38dLJ/KeIiDjN/1v8=" crossorigin="anonymous"></script>

<textarea id="template" cols="30" rows="10"></textarea>
<textarea id="code" class="codearea" cols="30" rows="10"></textarea>

<script>
  const templateTA = document.getElementById('template')
  const codeTA = document.getElementById('code')
  const codeCM = CodeMirror.fromTextArea(codeTA)

  const sparams = new URLSearchParams(location.search)

  templateTA.value = sparams.has('template')
    ? sparams.get('template')
    : 'Your template text...'

  codeTA.value = sparams.has('code')
    ? sparams.get('code')
    : 'Your code...'
</script>

<div id="btn-group">
  <button id="btn-execute" type="button">Execute!</button>
</div>

<div id="template-parsed" style="display: none;">
  <hr/>
  <div class="output">
  </div>
</div>

<div id="code-parsed" style="display: none;">
  <hr/>
  <div class="output">
  </div>
</div>

<div id="code-executed" style="display: none;">
  <hr/>
  <div class="output">
  </div>
</div>

<div id="template-applied" style="display: none;">
  <hr/>
  <div class="output">
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/prism.min.js" integrity="sha256-YZQM6/hLBZYkb01VYf17isoQM4qpaOP+aX96hhYrWhg=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/components/prism-clojure.min.js" integrity="sha256-dqJuEK5/MPu3IaeQRlBYg0ZPuodNyPUDziwjDBlcEbI=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism-tomorrow.min.css" integrity="sha256-xevuwyBEb2ZYh4nDhj0g3Z/rDBnM569hg9Vq6gEw/Sg=" crossorigin="anonymous" />

<script>
  const escapeHtml = (unsafe) => {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  const display = (htmlElement, obj) => {
    try {
      htmlElement.innerHTML = escapeHtml(obj)
    }
    catch (e) {
      htmlElement.innerHTML = obj
    }

    htmlElement.style.display = 'block'
  }

  const templateParsed = document.getElementById('template-parsed')
  const codeParsed = document.getElementById('code-parsed')
  const codeExecuted = document.getElementById('code-executed')
  const templateApplied = document.getElementById('template-applied')

  const btn = document.getElementById('btn-execute')

  btn.addEventListener('click', (_e) => {
    const templateTxt = templateTA.value
    const code = codeCM.getValue()

    console.time('code parse')
    const codeOutput = parseCode(code)
    console.timeEnd('code parse')

    display(codeParsed, JSON.stringify(codeOutput, null, 4))

    try {
      console.time('code execute')
      const executed = execute(codeOutput, new Map())
      display(codeExecuted, codeToString(executed).value)
    }
    catch (e) {
      display(codeExecuted, e.toString())
      throw e
    }
    finally {
      console.timeEnd('code execute')
    }
  })
</script>
