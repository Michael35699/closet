<script>
  const escapeHtml = (unsafe) => {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  const display = (htmlElement, obj) => {
    try {
      htmlElement.innerHTML = escapeHtml(obj)
    }
    catch (e) {
      htmlElement.innerHTML = obj
    }

    htmlElement.style.display = 'block'
  }

  const codeParsed = document.querySelector('#code-parsed > .output')
  const codeExecuted = document.querySelector('#code-executed > .output')
  const templateRendered = document.querySelector('#template-applied > .output')

  const btn = document.getElementById('btn-execute')

  btn.addEventListener('click', (_e) => {
    const code = codeCM.getValue()
    console.time('code parse')
    const codeOutput = parseCode(code)
    console.timeEnd('code parse')

    display(codeParsed, JSON.stringify(codeOutput, null, 4))

    /////////////////////

    try {
      console.time('code execute')
      const executed = execute(codeOutput, new Map())
      display(codeExecuted, codeToString(executed).value)
    }
    catch (e) {
      display(codeExecuted, e.toString())
      throw e
    }
    finally {
      console.timeEnd('code execute')
    }

    /////////////////////
    const templateTxt = templateTA.value

    const hlFilter = ({values}, {get, set}) => {
      set('heyo', 'my stringo')
      return values[0][0]
    }

    const emFilter = ({values}, {get, has}) => {

      return has('heyo') ? get('heyo') : 'default'
    }

    const optFilter = ({values}, {get, set}) => {
      return values[0][0]
    }

    const fm = mkFilterManager()
    fm.registerFilter('hl', hlFilter)
    fm.registerFilter('em', emFilter)

    console.time('template apply')
    const result = renderTemplate(templateTxt, fm)
    console.timeEnd('template apply')

    display(templateRendered, result)

  })
</script>
