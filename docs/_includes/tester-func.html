<script>
  const escapeHtml = (unsafe) => {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  const display = (htmlElement, obj, escape = true) => {
    if (escape) {
      htmlElement.innerHTML = escapeHtml(obj);
    }
    else {
      htmlElement.innerHTML = obj;
    }
  };

  const codeParsed = document.querySelector('#code-parsed > .output');
  const codeExecuted = document.querySelector('#code-executed > .output');
  const templateRendered = document.querySelector('#template-applied > .output');

  const btn = document.getElementById('btn-execute');

  btn.addEventListener('click', (_e) => {
    const code = codeCM.getValue();
    console.time('code parse');
    const codeOutput = parseCode(code);
    console.timeEnd('code parse');

    display(codeParsed, JSON.stringify(codeOutput, null, 4));

    /////////////////////

    try {
      console.time('code execute');
      const executed = execute(codeOutput, new Map());
      display(codeExecuted, codeToString(executed).value);
    }
    catch (e) {
      display(codeExecuted, e.toString());
      throw e;
    }
    finally {
      console.timeEnd('code execute');
    }

    /////////////////////
    const templateTxt = templateTA.value;

    const fm = mkFilterManager(meta = {tags: 'abc::def'});
    filterRecipes.mix(fm, 'mix', ', ');

    console.time('template apply');
    const result = renderTemplate(templateTxt, fm);
    console.timeEnd('template apply');

    display(templateRendered, result, escape=false);

  })
</script>
