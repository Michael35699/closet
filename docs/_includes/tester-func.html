<script>
  const escapeHtml = (unsafe) => {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  const display = (htmlElement, obj) => {
    try {
      htmlElement.innerHTML = escapeHtml(obj)
    }
    catch (e) {
      htmlElement.innerHTML = obj
    }

    htmlElement.style.display = 'block'
  }

  const templateParsed = document.querySelector('#template-parsed > .output')
  const codeParsed = document.querySelector('#code-parsed > .output')
  const codeExecuted = document.querySelector('#code-executed > .output')
  const templateApplied = document.querySelector('#template-applied > .output')

  const btn = document.getElementById('btn-execute')

  btn.addEventListener('click', (_e) => {
    const templateTxt = templateTA.value
    console.time('template parse')
    const templateOutput = parseTemplate(TemplateTxt)
    console.timeEnd('template parse')

    display(templateParsed, JSON.stringify(templateOutput, null, 4))

    /////////////////////

    const code = codeCM.getValue()
    console.time('code parse')
    const codeOutput = parseCode(code)
    console.timeEnd('code parse')

    display(codeParsed, JSON.stringify(codeOutput, null, 4))

    /////////////////////

    try {
      console.time('code execute')
      const executed = execute(codeOutput, new Map())
      display(codeExecuted, codeToString(executed).value)
    }
    catch (e) {
      display(codeExecuted, e.toString())
      throw e
    }
    finally {
      console.timeEnd('code execute')
    }
  })
</script>
