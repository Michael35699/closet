name: Keydown to reveal clozes
code: |
  Closet.browser.appendStyleScript(`
  .cl--obscure-hint {
    filter: blur(0.25em);
  }

  .cl--obscure-fix::after {
    content: 'XXXXXXXXXX';
    filter: blur(0.25em);
  }

  .cl--obscure-fix > span {
    display: none;
  }`)

  const makeObscureOnKd = (keycode, uid) => {
    return function removeObscureOnKd(event) {
      if (event.keyCode === keycode) {
        const nextTarget = document.querySelector(`.cl--obscure.cl--obscure-kd-${uid}`)

        if (nextTarget) {
          nextTarget.classList.remove('cl--obscure')
          nextTarget.classList.remove('cl--obscure-hint')
          nextTarget.classList.remove('cl--obscure-fix')
        }
      }
    }
  }

  const makeObscureOnKdAll = (keycode, uid) => {
    return function removeObscureOnKdAll(event) {
      if (event.keyCode === keycode) {
        const nextTargets = document.querySelectorAll(`.cl--obscure.cl--obscure-kd-${uid}`)

        for (const nt of nextTargets) {
          nt.classList.remove('cl--obscure')
          nt.classList.remove('cl--obscure-hint')
          nt.classList.remove('cl--obscure-fix')
        }
      }
    }
  }

  const wrappedClozeShow = Closet.wrappers.aftermath(
    (e, inter) => {
      const keyword = 'keydownToRevealObscure'

      if (!inter.global.has(keyword)) {
        const revealOnQ = makeObscureOnKd(KeyEvent.DOM_VK_Q, '6')
        const revealAllOnW = makeObscureOnKdAll(KeyEvent.DOM_VK_W, '5')

        document.addEventListener('keydown', revealOnQ)
        document.addEventListener('keydown', revealAllOnW)

        inter.global.set(keyword, true)
      }
    },
    Closet.recipes.clozeShow,
  )

  const obscureAndKeydown = (t, _i, isActive) => {
    return isActive
      ? `<span class="cl--obscure cl--obscure-hint cl--obscure-kd-5 cl--obscure-kd-6">${t.values[0].join('||')}</span>`
      : '[...]'
  }

  const obscureAndKeydownFix = (t, _i, isActive) => {
    return isActive
      ? `<span class="cl--obscure cl--obscure-fix cl--obscure-kd-5 cl--obscure-kd-6"><span>${t.values[0].join('||')}</span></span>`
      : '[...]'
  }

  filterManager.addRecipe(wrappedClozeShow({
    tagname: 'c',
    ellipsisMaker: obscureAndKeydown,
  }))

  filterManager.addRecipe(wrappedClozeShow({
    tagname: 'cx',
    ellipsisMaker: obscureAndKeydownFix,
  }))
