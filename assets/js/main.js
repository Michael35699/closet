var Closet=function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function e(t,e){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function r(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function o(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(n(arguments[e]));return t}var i=function(t,e,r,n){var o=r<0?Math.min(0,t.length+r):r;return t.slice(0,o)+e+t.slice(n)},s=function(t,e,r){return t.length-(r-e)},a=function(){function t(t){this.rootTag=t,this.zoom=[]}return t.prototype.traverse=function(t){var e,n;void 0===t&&(t=this.zoom);var o=this.rootTag;try{for(var i=r(t),s=i.next();!s.done;s=i.next()){var a=s.value;if(!o.innerTags[a])return null;o=o.innerTags[a]}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return o},t.prototype.exists=function(t){return void 0===t&&(t=this.zoom),!!this.traverse(t)},t.prototype.getTagInfo=function(t){return void 0===t&&(t=this.zoom),this.traverse(t)},t.prototype.getTag=function(t){void 0===t&&(t=this.zoom);var e=this.traverse(t);return e?e.data:null},t.prototype.getOffsets=function(t){void 0===t&&(t=this.zoom);var e=this.traverse(t);return e?[0,e.start]:null},t.prototype.setZoom=function(t){this.zoom=t},t}(),u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function l(t,e){return t(e={exports:{}},e.exports),e.exports}var f=l((function(t){var e,r;e=u,r=function(){function t(e,r,n){return this.id=++t.highestId,this.name=e,this.symbols=r,this.postprocess=n,this}function e(t,e,r,n){this.rule=t,this.dot=e,this.reference=r,this.data=[],this.wantedBy=n,this.isComplete=this.dot===t.symbols.length}function r(t,e){this.grammar=t,this.index=e,this.states=[],this.wants={},this.scannable=[],this.completed={}}function n(t,e){this.rules=t,this.start=e||this.rules[0].name;var r=this.byName={};this.rules.forEach((function(t){r.hasOwnProperty(t.name)||(r[t.name]=[]),r[t.name].push(t)}))}function o(){this.reset("")}function i(t,e,i){if(t instanceof n){var s=t;i=e}else s=n.fromCompiled(t,e);for(var a in this.grammar=s,this.options={keepHistory:!1,lexer:s.lexer||new o},i||{})this.options[a]=i[a];this.lexer=this.options.lexer,this.lexerState=void 0;var u=new r(s,0);this.table=[u],u.wants[s.start]=[],u.predict(s.start),u.process(),this.current=0}return t.highestId=0,t.prototype.toString=function(t){function e(t){return t.literal?JSON.stringify(t.literal):t.type?"%"+t.type:t.toString()}var r=void 0===t?this.symbols.map(e).join(" "):this.symbols.slice(0,t).map(e).join(" ")+" ● "+this.symbols.slice(t).map(e).join(" ");return this.name+" → "+r},e.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},e.prototype.nextState=function(t){var r=new e(this.rule,this.dot+1,this.reference,this.wantedBy);return r.left=this,r.right=t,r.isComplete&&(r.data=r.build(),r.right=void 0),r},e.prototype.build=function(){var t=[],e=this;do{t.push(e.right.data),e=e.left}while(e.left);return t.reverse(),t},e.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,i.fail))},r.prototype.process=function(t){for(var e=this.states,r=this.wants,n=this.completed,o=0;o<e.length;o++){var s=e[o];if(s.isComplete){if(s.finish(),s.data!==i.fail){for(var a=s.wantedBy,u=a.length;u--;){var l=a[u];this.complete(l,s)}if(s.reference===this.index){var f=s.rule.name;(this.completed[f]=this.completed[f]||[]).push(s)}}}else{if("string"!=typeof(f=s.rule.symbols[s.dot])){this.scannable.push(s);continue}if(r[f]){if(r[f].push(s),n.hasOwnProperty(f)){var h=n[f];for(u=0;u<h.length;u++){var c=h[u];this.complete(s,c)}}}else r[f]=[s],this.predict(f)}}},r.prototype.predict=function(t){for(var r=this.grammar.byName[t]||[],n=0;n<r.length;n++){var o=r[n],i=this.wants[t],s=new e(o,0,this.index,i);this.states.push(s)}},r.prototype.complete=function(t,e){var r=t.nextState(e);this.states.push(r)},n.fromCompiled=function(e,r){var o=e.Lexer;e.ParserStart&&(r=e.ParserStart,e=e.ParserRules);var i=new n(e=e.map((function(e){return new t(e.name,e.symbols,e.postprocess)})),r);return i.lexer=o,i},o.prototype.reset=function(t,e){this.buffer=t,this.index=0,this.line=e?e.line:1,this.lastLineBreak=e?-e.col:0},o.prototype.next=function(){if(this.index<this.buffer.length){var t=this.buffer[this.index++];return"\n"===t&&(this.line+=1,this.lastLineBreak=this.index),{value:t}}},o.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},o.prototype.formatError=function(t,e){var r=this.buffer;if("string"==typeof r){var n=r.indexOf("\n",this.index);-1===n&&(n=r.length);var o=r.substring(this.lastLineBreak,n),i=this.index-this.lastLineBreak;return e+=" at line "+this.line+" col "+i+":\n\n",e+="  "+o+"\n",e+="  "+Array(i).join(" ")+"^"}return e+" at index "+(this.index-1)},i.fail={},i.prototype.feed=function(t){var e,n=this.lexer;for(n.reset(t,this.lexerState);e=n.next();){var i=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var s=this.current+1,a=new r(this.grammar,s);this.table.push(a);for(var u=void 0!==e.text?e.text:e.value,l=n.constructor===o?e.value:e,f=i.scannable,h=f.length;h--;){var c=f[h],p=c.rule.symbols[c.dot];if(p.test?p.test(l):p.type?p.type===e.type:p.literal===u){var d=c.nextState({data:l,token:e,isToken:!0,reference:s-1});a.states.push(d)}}if(a.process(),0===a.states.length){var y=new Error(this.reportError(e));throw y.offset=this.current,y.token=e,y}this.options.keepHistory&&(i.lexerState=n.save()),this.current++}return i&&(this.lexerState=n.save()),this.results=this.finish(),this},i.prototype.reportError=function(t){var e=[],r=(t.type?t.type+" token: ":"")+JSON.stringify(void 0!==t.value?t.value:t);e.push(this.lexer.formatError(t,"Syntax error")),e.push("Unexpected "+r+". Instead, I was expecting to see one of the following:\n");var n=this.table.length-2;return this.table[n].states.filter((function(t){var e=t.rule.symbols[t.dot];return e&&"string"!=typeof e})).map((function(t){return this.buildFirstStateStack(t,[])||[t]}),this).forEach((function(t){var r=t[0],n=r.rule.symbols[r.dot],o=this.getSymbolDisplay(n);e.push("A "+o+" based on:"),this.displayStateStack(t,e)}),this),e.push(""),e.join("\n")},i.prototype.displayStateStack=function(t,e){for(var r,n=0,o=0;o<t.length;o++){var i=t[o],s=i.rule.toString(i.dot);s===r?n++:(n>0&&e.push("    ⬆ ︎"+n+" more lines identical to this"),n=0,e.push("    "+s)),r=s}},i.prototype.getSymbolDisplay=function(t){var e=typeof t;if("string"===e)return t;if("object"===e&&t.literal)return JSON.stringify(t.literal);if("object"===e&&t instanceof RegExp)return"character matching "+t;if("object"===e&&t.type)return t.type+" token";throw new Error("Unknown symbol type: "+t)},i.prototype.buildFirstStateStack=function(t,e){if(-1!==e.indexOf(t))return null;if(0===t.wantedBy.length)return[t];var r=t.wantedBy[0],n=[t].concat(e),o=this.buildFirstStateStack(r,n);return null===o?null:[t].concat(o)},i.prototype.save=function(){var t=this.table[this.current];return t.lexerState=this.lexerState,t},i.prototype.restore=function(t){var e=t.index;this.current=e,this.table[e]=t,this.table.splice(e+1),this.lexerState=t.lexerState,this.results=this.finish()},i.prototype.rewind=function(t){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[t])},i.prototype.finish=function(){var t=[],e=this.grammar.start;return this.table[this.table.length-1].states.forEach((function(r){r.rule.name===e&&r.dot===r.rule.symbols.length&&0===r.reference&&r.data!==i.fail&&t.push(r)})),t.map((function(t){return t.data}))},{Parser:i,Grammar:n,Rule:t}},t.exports?t.exports=r():e.nearley=r()})),h=l((function(t){var e,r;e=u,r=function(){var t=Object.prototype.hasOwnProperty,e=Object.prototype.toString,r="boolean"==typeof(new RegExp).sticky;function n(t){return t&&"[object RegExp]"===e.call(t)}function o(t){return t&&"object"==typeof t&&!n(t)&&!Array.isArray(t)}function i(t){return"("+t+")"}function s(t){return t.length?"(?:"+t.map((function(t){return"(?:"+t+")"})).join("|")+")":"(?!)"}function a(t){if("string"==typeof t)return"(?:"+t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(n(t)){if(t.ignoreCase)throw new Error("RegExp /i flag not allowed");if(t.global)throw new Error("RegExp /g flag is implied");if(t.sticky)throw new Error("RegExp /y flag is implied");if(t.multiline)throw new Error("RegExp /m flag is implied");return t.source}throw new Error("Not a pattern: "+t)}function u(e,r){if(o(r)||(r={match:r}),r.include)throw new Error("Matching rules cannot also include states");var i={defaultType:e,lineBreaks:!!r.error||!!r.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var s in r)t.call(r,s)&&(i[s]=r[s]);if("string"==typeof i.type&&e!==i.type)throw new Error("Type transform cannot be a string (type '"+i.type+"' for token '"+e+"')");var a=i.match;return i.match=Array.isArray(a)?a:a?[a]:[],i.match.sort((function(t,e){return n(t)&&n(e)?0:n(e)?-1:n(t)?1:e.length-t.length})),i}function l(t){return Array.isArray(t)?function(t){for(var e=[],r=0;r<t.length;r++){var n=t[r];if(n.include)for(var o=[].concat(n.include),i=0;i<o.length;i++)e.push({include:o[i]});else{if(!n.type)throw new Error("Rule has no type: "+JSON.stringify(n));e.push(u(n.type,n))}}return e}(t):function(t){for(var e=Object.getOwnPropertyNames(t),r=[],n=0;n<e.length;n++){var i=e[n],s=t[i],a=[].concat(s);if("include"!==i){var l=[];a.forEach((function(t){o(t)?(l.length&&r.push(u(i,l)),r.push(u(i,t)),l=[]):l.push(t)})),l.length&&r.push(u(i,l))}else for(var f=0;f<a.length;f++)r.push({include:a[f]})}return r}(t)}var f=u("error",{lineBreaks:!0,shouldThrow:!0});function h(t,e){for(var o=null,u=Object.create(null),l=!0,h=null,c=[],p=[],d=0;d<t.length;d++)t[d].fallback&&(l=!1);for(d=0;d<t.length;d++){var y=t[d];if(y.include)throw new Error("Inheritance is not allowed in stateless lexers");if(y.error||y.fallback){if(o)throw!y.fallback==!o.fallback?new Error("Multiple "+(y.fallback?"fallback":"error")+" rules not allowed (for token '"+y.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+y.defaultType+"')");o=y}var g=y.match.slice();if(l)for(;g.length&&"string"==typeof g[0]&&1===g[0].length;)u[g.shift().charCodeAt(0)]=y;if(y.pop||y.push||y.next){if(!e)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+y.defaultType+"')");if(y.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+y.defaultType+"')")}if(0!==g.length){l=!1,c.push(y);for(var v=0;v<g.length;v++){var m=g[v];if(n(m))if(null===h)h=m.unicode;else if(h!==m.unicode&&!1===y.fallback)throw new Error("If one rule is /u then all must be")}var b=s(g.map(a)),x=new RegExp(b);if(x.test(""))throw new Error("RegExp matches empty string: "+x);if(new RegExp("|"+b).exec("").length-1>0)throw new Error("RegExp has capture groups: "+x+"\nUse (?: … ) instead");if(!y.lineBreaks&&x.test("\n"))throw new Error("Rule should declare lineBreaks: "+x);p.push(i(b))}}var w=o&&o.fallback,k=r&&!w?"ym":"gm",S=r||w?"":"|";return!0===h&&(k+="u"),{regexp:new RegExp(s(p)+S,k),groups:c,fast:u,error:o||f}}function c(t,e,r){var n=t&&(t.push||t.next);if(n&&!r[n])throw new Error("Missing state '"+n+"' (in token '"+t.defaultType+"' of state '"+e+"')");if(t&&t.pop&&1!=+t.pop)throw new Error("pop must be 1 (in token '"+t.defaultType+"' of state '"+e+"')")}var p=function(t,e){this.startState=e,this.states=t,this.buffer="",this.stack=[],this.reset()};p.prototype.reset=function(t,e){return this.buffer=t||"",this.index=0,this.line=e?e.line:1,this.col=e?e.col:1,this.queuedToken=e?e.queuedToken:null,this.queuedThrow=e?e.queuedThrow:null,this.setState(e?e.state:this.startState),this.stack=e&&e.stack?e.stack.slice():[],this},p.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedThrow:this.queuedThrow}},p.prototype.setState=function(t){if(t&&this.state!==t){this.state=t;var e=this.states[t];this.groups=e.groups,this.error=e.error,this.re=e.regexp,this.fast=e.fast}},p.prototype.popState=function(){this.setState(this.stack.pop())},p.prototype.pushState=function(t){this.stack.push(this.state),this.setState(t)};var d=r?function(t,e){return t.exec(e)}:function(t,e){var r=t.exec(e);return 0===r[0].length?null:r};function y(){return this.value}if(p.prototype._getGroup=function(t){for(var e=this.groups.length,r=0;r<e;r++)if(void 0!==t[r+1])return this.groups[r];throw new Error("Cannot find token type for matched text")},p.prototype.next=function(){var t=this.index;if(this.queuedGroup){var e=this._token(this.queuedGroup,this.queuedText,t);return this.queuedGroup=null,this.queuedText="",e}var r=this.buffer;if(t!==r.length){if(s=this.fast[r.charCodeAt(t)])return this._token(s,r.charAt(t),t);var n=this.re;n.lastIndex=t;var o=d(n,r),i=this.error;if(null==o)return this._token(i,r.slice(t,r.length),t);var s=this._getGroup(o),a=o[0];return i.fallback&&o.index!==t?(this.queuedGroup=s,this.queuedText=a,this._token(i,r.slice(t,o.index),t)):this._token(s,a,t)}},p.prototype._token=function(t,e,r){var n=0;if(t.lineBreaks){var o=/\n/g,i=1;if("\n"===e)n=1;else for(;o.exec(e);)n++,i=o.lastIndex}var s={type:"function"==typeof t.type&&t.type(e)||t.defaultType,value:"function"==typeof t.value?t.value(e):e,text:e,toString:y,offset:r,lineBreaks:n,line:this.line,col:this.col},a=e.length;if(this.index+=a,this.line+=n,0!==n?this.col=a-i+1:this.col+=a,t.shouldThrow)throw new Error(this.formatError(s,"invalid syntax"));return t.pop?this.popState():t.push?this.pushState(t.push):t.next&&this.setState(t.next),s},"undefined"!=typeof Symbol&&Symbol.iterator){var g=function(t){this.lexer=t};g.prototype.next=function(){var t=this.lexer.next();return{value:t,done:!t}},g.prototype[Symbol.iterator]=function(){return this},p.prototype[Symbol.iterator]=function(){return new g(this)}}return p.prototype.formatError=function(t,e){if(null==t){var r=this.buffer.slice(this.index);t={text:r,offset:this.index,lineBreaks:-1===r.indexOf("\n")?0:1,line:this.line,col:this.col}}var n=Math.max(0,t.offset-t.col+1),o=t.lineBreaks?t.text.indexOf("\n"):t.text.length,i=this.buffer.substring(n,t.offset+o);return e+=" at line "+t.line+" col "+t.col+":\n\n",e+="  "+i+"\n",e+="  "+Array(t.col).join(" ")+"^"},p.prototype.clone=function(){return new p(this.states,this.state)},p.prototype.has=function(t){return!0},{compile:function(t){var e=h(l(t));return new p({start:e},"start")},states:function(t,e){var r=t.$all?l(t.$all):[];delete t.$all;var n=Object.getOwnPropertyNames(t);e||(e=n[0]);for(var o=Object.create(null),i=0;i<n.length;i++)o[b=n[i]]=l(t[b]).concat(r);for(i=0;i<n.length;i++)for(var s=o[b=n[i]],a=Object.create(null),u=0;u<s.length;u++){var f=s[u];if(f.include){var d=[u,1];if(f.include!==b&&!a[f.include]){a[f.include]=!0;var y=o[f.include];if(!y)throw new Error("Cannot include nonexistent state '"+f.include+"' (in state '"+b+"')");for(var g=0;g<y.length;g++){var v=y[g];-1===s.indexOf(v)&&d.push(v)}}s.splice.apply(s,d),u--}}var m=Object.create(null);for(i=0;i<n.length;i++){var b;m[b=n[i]]=h(o[b],!0)}for(i=0;i<n.length;i++){var x=n[i],w=m[x],k=w.groups;for(u=0;u<k.length;u++)c(k[u],x,m);var S=Object.getOwnPropertyNames(w.fast);for(u=0;u<S.length;u++)c(w.fast[S[u]],x,m)}return new p(m,e)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(t){for(var e=Object.create(null),r=Object.create(null),n=Object.getOwnPropertyNames(t),o=0;o<n.length;o++){var i=n[o],s=t[i];(Array.isArray(s)?s:[s]).forEach((function(t){if((r[t.length]=r[t.length]||[]).push(t),"string"!=typeof t)throw new Error("keyword must be string (in keyword '"+i+"')");e[t]=i}))}function a(t){return JSON.stringify(t)}var u="";for(var l in u+="switch (value.length) {\n",r){var f=r[l];u+="case "+l+":\n",u+="switch (value) {\n",f.forEach((function(t){var r=e[t];u+="case "+a(t)+": return "+a(r)+"\n"})),u+="}\n"}return u+="}\n",Function("value",u)}}},t.exports?t.exports=r():e.moo=r()})).states({main:{tagopen:{match:"[[",push:"key"},EOF:{match:/\$$/u},text:{match:/[\s\S]+?(?=\[\[|\$$)/u,lineBreaks:!0}},key:{keyname:{match:/[a-zA-Z]+\d*/u},sep:{match:"::",next:"intag"},tagclose:{match:"]]",pop:1}},intag:{tagopen:{match:"[[",push:"key"},tagclose:{match:"]]",pop:1},valuestext:{match:/[\s\S]+?(?=\[\[|\]\])/u,lineBreaks:!0}}}),c=function(){function t(t,e,r,n,o,i,s){this.fullKey=t,this.key=e,this.num=r,this.valuesRaw=n,this.values=function(t){return null===t?[]:t.split("::").map((function(t){return t.split("||")}))}(n),this.fullOccur=o,this.occur=i,this.path=s}return t.prototype.shadowValuesRaw=function(e){return new t(this.fullKey,this.key,this.num,e,this.fullOccur,this.occur,this.path)},t.prototype.getDefaultRepresentation=function(){return null===this.valuesRaw?"[["+this.fullKey+"]]":"[["+this.fullKey+"::"+this.valuesRaw+"]]"},t.prototype.getRawRepresentation=function(){var t;return null!==(t=this.valuesRaw)&&void 0!==t?t:""},t.prototype.getFilterKey=function(){return this.key},t}(),p=function(t,e,r,n,o){void 0===o&&(o=!1),this.start=t,this.end=e,this.data=r,this.innerTags=n,this.naked=o},d=/^([^0-9]+)([0-9]*)$/u,y=function(){function t(){this.tagCounter=new Map,this.tagPathStack=[],this.tagPathNext=0}return t.prototype.getAndInc=function(t){var e=this.tagCounter.has(t)?this.tagCounter.get(t)+1:0;return this.tagCounter.set(t,e),e},t.prototype.signalTagOpen=function(){this.tagPathStack.push(this.tagPathNext),this.tagPathNext=0},t.prototype.build=function(t,e){var r=t.match(d),n=r[1],i=0===r[2].length?null:Number(r[2]),s=this.getAndInc(t),a=t===n?s:this.getAndInc(n),u=new c(t,n,i,e,s,a,o(this.tagPathStack));return this.tagPathNext=this.tagPathStack.pop()+1,u},t.prototype.reset=function(){this.tagCounter.clear(),this.tagPathStack.length=0,this.tagPathNext=0},t}(),g=function(){function t(){this.fixedLeftOffset=0}return t.prototype.addToLeftOffset=function(t){this.fixedLeftOffset+=t},t.prototype.resetLeftOffset=function(){var t=this.fixedLeftOffset;return this.fixedLeftOffset=0,t},t.prototype.build=function(t,e,r,n,o){return void 0===o&&(o=!1),new p(t+this.fixedLeftOffset,e+this.fixedLeftOffset,r,n,o)},t}();function v(t){return t[0]}var m=function(t){return n(t,1)[0].map((function(t){return t.value})).join("")},b=new y,x=new g,w={Lexer:h,ParserRules:[{name:"start",symbols:["content",h.has("EOF")?{type:"EOF"}:EOF],postprocess:function(t){var e=n(t,2),r=n(e[0],2),o=r[0],i=r[1],s=e[1];return x.build(0,s.offset,b.build("base",o),i,!0)}},{name:"content$ebnf$1",symbols:[]},{name:"content$ebnf$1$subexpression$1",symbols:["tag","_"]},{name:"content$ebnf$1",symbols:["content$ebnf$1","content$ebnf$1$subexpression$1"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"content",symbols:["_","content$ebnf$1"],postprocess:function(t){var e=n(t,2),r=e[0],o=e[1];return[r+o.map((function(t){var e=n(t,2),r=e[0],o=e[1];return v(r).join("")+o})).join(""),o.map(v).map((function(t){return t[1]}))]}},{name:"tag",symbols:["tagopen","inner",h.has("tagclose")?{type:"tagclose"}:tagclose],postprocess:function(t){var e=n(t,3),r=e[0],o=n(e[1],3),i=o[0],s=o[1],a=o[2],u=e[2],l="string"==typeof s;return[["[[",l?i+"::"+s:i,"]]"],x.build(r,u.offset+"]]".length,b.build(i,l?s:null),a.map((function(t){return t[1]})))]}},{name:"tagopen",symbols:[h.has("tagopen")?{type:"tagopen"}:tagopen],postprocess:function(t){var e=n(t,1)[0];return b.signalTagOpen(),e.offset+e.value.length-"[[".length}},{name:"inner$ebnf$1$subexpression$1$ebnf$1",symbols:[]},{name:"inner$ebnf$1$subexpression$1$ebnf$1$subexpression$1",symbols:["tag","_values"]},{name:"inner$ebnf$1$subexpression$1$ebnf$1",symbols:["inner$ebnf$1$subexpression$1$ebnf$1","inner$ebnf$1$subexpression$1$ebnf$1$subexpression$1"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"inner$ebnf$1$subexpression$1",symbols:[h.has("sep")?{type:"sep"}:sep,"_values","inner$ebnf$1$subexpression$1$ebnf$1"]},{name:"inner$ebnf$1",symbols:["inner$ebnf$1$subexpression$1"],postprocess:v},{name:"inner$ebnf$1",symbols:[],postprocess:function(){return null}},{name:"inner",symbols:[h.has("keyname")?{type:"keyname"}:keyname,"inner$ebnf$1"],postprocess:function(t){var e=n(t,2),r=e[0],o=e[1];return[r.value,o?o[1]+o[2].map((function(t){var e=n(t,2),r=e[0],o=e[1];return v(r).join("")+o})).join(""):null,o?o[2].map(v):[]]}},{name:"_values$ebnf$1",symbols:[]},{name:"_values$ebnf$1",symbols:["_values$ebnf$1",h.has("valuestext")?{type:"valuestext"}:valuestext],postprocess:function(t){return t[0].concat([t[1]])}},{name:"_values",symbols:["_values$ebnf$1"],postprocess:m},{name:"_$ebnf$1",symbols:[]},{name:"_$ebnf$1",symbols:["_$ebnf$1",h.has("text")?{type:"text"}:text],postprocess:function(t){return t[0].concat([t[1]])}},{name:"_",symbols:["_$ebnf$1"],postprocess:m}],ParserStart:"start"},k=function(t){return x.build(0,t.length,b.build("base",t),[],!0)},S=function(t){var e=new f.Parser(f.Grammar.fromCompiled(w)),r=null;try{r=e.feed(t+"$").results}catch(e){r=[k(t)]}return r.length,r[0]},$=function(t){var e=S(t);return b.reset(),e},E=function(t){var e,n,o=[];try{for(var i=r(t),s=i.next();!s.done;s=i.next()){var a=s.value;b.signalTagOpen();var u=S(a);o.push(u),x.addToLeftOffset(a.length)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}var l=x.resetLeftOffset(),f=x.build(0,l,b.build("base",t.join("")),o,!0);return b.reset(),f},_=function(t,e){for(var r=t,o=!1,i=0;i<50&&!o;i++){var s=$(r),u=new a(s),l=n(T(r,s,1,e.filterProcessor({iteration:{index:i},template:u,baseDepth:1})),4);r=l[0],o=l[2],e.executeDeferred()}return e.reset(),r},O=function(t,e){var o,i,s=[];try{for(var a=r(e),u=a.next();!u.done;u=a.next()){var l=n(u.value,2),f=l[0],h=l[1];s.push(t.slice(f,h))}}catch(t){o={error:t}}finally{try{u&&!u.done&&(i=a.return)&&i.call(a)}finally{if(o)throw o.error}}return s},N=function(t,e){for(var r=t,o=!1,i=0;i<50&&!o;i++){var s=E(r),u=new a(s),l=n(T(r.join(""),s,2,e.filterProcessor({iteration:{index:i},template:u,baseDepth:2})),4),f=l[0],h=l[2],c=l[3];r=O(f,c),o=h,e.executeDeferred()}return e.reset(),r},T=function(t,e,r,o){var a=[],u=function(t,e){var l=n(t,3),f=l[0],h=l[1],c=l[2];h.push(h[h.length-1]);var p=n(e.innerTags.reduce(u,[f,h,!0]),3),d=p[0],y=p[1],g=p[2];y.push(y.pop()-y[y.length-1]);var v=y.pop(),m=y.pop(),b=n(function(t,e,r,n){return[t+r,e+r+n]}(e.start,e.end,m,v),2),x=b[0],w=b[1],k=null,S=e.data.path.length+1;S<=r?(k=d.slice(x,w),S===r&&a.push([x,w])):k=null===e.data.valuesRaw?null:d.slice(x+("[[".length+e.data.fullKey.length+"::".length),w-"]]".length);var $=e.data.shadowValuesRaw(k),E=o($,{ready:g,depth:S-r}),_=n(null===E.result?[d,0]:function(t,e,r,n){return[i(t,e,r,n),s(e,r,n)]}(d,E.result,x,w),2),O=_[0],N=v+m+_[1];return y.push(N),[O,y,c&&E.ready]},l=n(u([t,[0,0],!0],e),3);return[l[0],l[1],l[2],a]},j=function(){function t(t){this.storage=t}return t.prototype.set=function(t,e){this.storage.set(t,e)},t.prototype.has=function(t){return this.storage.has(t)},t.prototype.get=function(t,e){return void 0===e&&(e=null),this.has(t)?this.storage.get(t):e},t.prototype.fold=function(t,e,r){var n=e(this.get(t,r));return this.set(t,n),n},t.prototype.over=function(t,e,r){this.has(t)?e(this.get(t,r)):(e(r),this.set(t,r))},t.prototype.delete=function(t){this.storage.delete(t)},t.prototype.clear=function(){this.storage.clear()},t}(),I=function(t){return{result:t,ready:!0}},P=function(t,e){return{result:t,ready:e}},R=function(t){return function(e,r){var n,o=t(e,r);switch(typeof o){case"string":return I(o);case"object":return{result:o.result,ready:null===(n=o.ready)||void 0===n||n};default:return{result:null,ready:!1}}}},A=function(t,e){return P(t.getRawRepresentation(),e.ready)},z=function(t){return I(t.getRawRepresentation())},M=function(t,e){return P(t.getDefaultRepresentation(),e.ready)},C=function(){function t(){this.filters=new Map}return t.prototype.register=function(t,e){this.filters.set(t,e)},t.prototype.has=function(t){return"raw"===t||"base"===t||this.filters.has(t)},t.prototype.get=function(t){return"base"===t?A:"raw"===t?z:this.filters.has(t)?R(this.filters.get(t)):null},t.prototype.getOrDefault=function(t){var e=this.get(t);return e||M},t.prototype.unregisterFilter=function(t){this.filters.delete(t)},t.prototype.clearFilters=function(){this.filters.clear()},t.prototype.execute=function(t,e){return R(this.getOrDefault(t.getFilterKey()))(t,e)},t}(),L=function(t){return(t+1>>>1)-1},D=function(t){return 1+(t<<1)},B=function(t){return t+1<<1},F=function(){function t(t){void 0===t&&(t=function(t,e){return t>e}),this._heap=[],this._comparator=t}return t.prototype.greater=function(t,e){return this._comparator(this._heap[t],this._heap[e])},t.prototype.swap=function(t,e){var r;r=n([this._heap[e],this._heap[t]],2),this._heap[t]=r[0],this._heap[e]=r[1]},t.prototype.siftUp=function(){for(var t=this.size()-1;t>0&&this.greater(t,L(t));)this.swap(t,L(t)),t=L(t)},t.prototype.siftDown=function(){for(var t=0;D(t)<this.size()&&this.greater(D(t),t)||B(t)<this.size()&&this.greater(B(t),t);){var e=B(t)<this.size()&&this.greater(B(t),D(t))?B(t):D(t);this.swap(t,e),t=e}},t.prototype.size=function(){return this._heap.length},t.prototype.isEmpty=function(){return 0===this.size()},t.prototype.peek=function(){return this._heap[0]},t.prototype.push=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e.forEach((function(e){t._heap.push(e),t.siftUp()})),this.size()},t.prototype.pop=function(){var t=this.peek(),e=this.size()-1;return e>0&&this.swap(0,e),this._heap.pop(),this.siftDown(),t},t.prototype.generate=function(){var t;return e(this,(function(e){switch(e.label){case 0:t=this.pop(),e.label=1;case 1:return t?[4,t]:[3,3];case 2:return e.sent(),t=this.pop(),[3,1];case 3:return[2,null]}}))},t}(),q={priority:50,persistent:!1},H=function(t,e){return t.priority<e.priority},G=function(){function t(){this._deferred=new Map,this._blocked=new Set}return t.prototype.register=function(t,e,r){void 0===r&&(r=q),this._deferred.set(t,{keyword:t,procedure:e,priority:r.priority,persistent:r.persistent})},t.prototype.registerIfNotExists=function(t,e,r){void 0===r&&(r=q),this.isRegistered(t)||this.register(t,e,r)},t.prototype.unregister=function(t){this._deferred.delete(t)},t.prototype.isRegistered=function(t){return this._deferred.has(t)},t.prototype.block=function(t){this._blocked.add(t)},t.prototype.unblock=function(t){this._blocked.delete(t)},t.prototype.isBlocked=function(t){return this._blocked.has(t)},t.prototype.clear=function(){this._deferred.clear(),this._blocked.clear()},t.prototype.executeEach=function(){for(var t,e,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var s=new F(H);s.push.apply(s,o(this._deferred.values()));try{for(var a=r(s.generate()),u=a.next();!u.done;u=a.next()){var l=u.value;this.isBlocked(l.keyword)||l.procedure.apply(l,o([l.keyword],n)),l.persistent||this.unregister(l.keyword)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}this._blocked.clear()},t}(),K=function(){function t(t,e){void 0===t&&(t={}),void 0===e&&(e=new Map),this.filters=new C,this.deferred=new G,this.preset=t,this.cache=new j(new Map),this.memory=new j(e)}return t.prototype.filterProcessor=function(t){var e=this;return function(r,n){var o=Object.assign(e.preset,t,n,{cache:e.cache,memory:e.memory,filters:e.filters,deferred:e.deferred});return e.filters.execute(r,o)}},t.prototype.executeDeferred=function(){this.deferred.executeEach()},t.prototype.clearMemory=function(){this.memory.clear()},t.prototype.reset=function(){this.cache.clear(),this.deferred.clear()},t.prototype.addRecipe=function(t){t(this.filters)},t}(),J=function(t){return t},U=function(t,e){var n,o,i,s,a=[];try{for(var u=r(e),l=u.next();!l.done;l=u.next()){var f=t[d=l.value];f&&a.push(f)}}catch(t){n={error:t}}finally{try{l&&!l.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}if(e.length<t.length){var h=Array.from(new Array(t.length-e.length),(function(t,r){return r+e.length}));try{for(var c=r(h),p=c.next();!p.done;p=c.next()){var d=p.value;a.push(t[d])}}catch(t){i={error:t}}finally{try{p&&!p.done&&(s=c.return)&&s.call(c)}finally{if(i)throw i.error}}}return a},V=function(t,e){if(t.length>=e)return t;var r=Array.from(new Array(e-t.length),(function(e,r){return r+t.length})),n=o(t);return r.forEach((function(t){return n.splice(Math.floor(Math.random()*(n.length+1)),0,t)})),n},X=function(t){return t.map((function(t){return Number(t)})).filter((function(t){return!isNaN(t)}))},Z=function(t,e){return e.includes(",")?e.split(","):t[0]},Q=function(){function t(t){var e=void 0===t?{}:t,r=e.separator,n=void 0===r?", ":r,o=e.separatorOuter,i=void 0===o?"; ":o,s=e.mapper,a=void 0===s?J:s,u=e.mapperOuter,l=void 0===u?J:u,f=e.postprocess,h=void 0===f?J:f;this.separator=n,this.separatorOuter=i,this.mapper=a,this.mapperOuter=l,this.postprocess=h}return t.prototype.stylize=function(t){var e=this;return this.postprocess(t.map((function(t){return t.map(e.mapper).join(e.separator)})).map(this.mapperOuter).join(this.separatorOuter))},t.prototype.stylizeInner=function(t){return this.mapperOuter(t.map(this.mapper).join(this.separator))},t}(),W=/%(\d*)/u,Y={shuffling:function(t,e){return void 0===e&&(e=new Q),function(r){r.register(t,(function(t,r){var n=t.fullKey,o=t.fullOccur,i=t.num,s=t.values,a=r.cache,u=r.memory,l=r.deferred,f=r.ready,h=n+":"+o,c=n+":waitingSet",p=h+":apply";if(a.get(p,!1)){if(a.get(c,new Set).size>0)return;for(var d=[],y=a.get(n,[]),g=0;g<s[0].length;g++)d.push(y.shift());return e.stylizeInner(d)}if(f){if(!i)return e.stylizeInner(function(t){for(var e=t.slice(0),r=t.length,n=null,o=null;0!==r;)o=Math.floor(Math.random()*r),n=e[r-=1],e[r]=e[o],e[o]=n;return e}(s[0]));a.fold(n,(function(t){return t.concat(s[0])}),[]),l.registerIfNotExists(p,(function(){a.set(p,!0),a.over(c,(function(t){return t.delete(h)}),new Set)}));var v=n+":mix";l.registerIfNotExists(v,(function(){a.get(c,new Set).size>0||a.fold(n,(function(t){var e=u.fold(n,(function(t){return V(t,a.get(n,[]).length)}),[]);return U(t,e)}),[])}))}else a.over(c,(function(t){return t.add(h)}),new Set)}))}},ordering:function(t,e){return function(n){n.register(t,(function(t,n){var o=t.key,i=t.fullOccur,s=t.values,a=t.valuesRaw,u=n.deferred,l=n.cache,f=o+":ord:occupied",h=X(Z(s,a)).filter((function(t){return!l.get(f,[]).includes(t)}));l.fold(f,(function(t){return t.concat(h)}),[]);var c=new Set(h.map((function(t){return""+e+t}))),p=o+":"+i+":ord";return u.register(p,(function(){var t,e,n=[],o=function(t){if(u.block(t+":mix"),0!==l.get(t+":waitingSet",new Set).size)return"continue";var e=l.get(t,[]),r=V(l.get(p,[]),e.length);l.fold(t,(function(t){return U(t,r)}),[]),n.push(t),l.set(p,r)};try{for(var i=r(c),s=i.next();!s.done;s=i.next()){o(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}n.forEach((function(t){return c.delete(t)})),0===c.size&&u.unregister(p)}),{priority:35,persistent:!0}),""}))}},cloze:function(t){return function(e){e.register(t,(function(t,e){}))}},random:function(t){return function(e){e.register(t,(function(t){t.num;var e=t.values,r=t.valuesRaw,o=n(X(Z(e,r)),3),i=o[0],s=void 0===i?1:i,a=o[1],u=void 0===a?null:a,l=o[2],f=void 0===l?1:l;return String(s>u?0:(s+Math.floor(Math.random()*u-s))*f)}))}},multipleChoice:function(t){return function(e){e.register(t,(function(t,e){}))}},debug:function(t){t.register("tagpath",(function(t){return t.path.join(":")})),t.register("never",(function(){})),t.register("empty",(function(){return""})),t.register("key",(function(t){return t.key})),t.register("memorytest",(function(t,e){var r=e.memory;return String(r.fold("base:memorytest",(function(t){return++t}),0))}))},meta:function(t){t.register("def",(function(t,e){var r=t.values,n=e.filters,o=r;return n.register(r[0][0],(function(t){var e=t.values;return{result:"[["+o.slice(1).map((function(t){return t.map((function(t){var r=t.match(W);if(r){var n=0===r[1].length?0:Number(r[1]);return e[n]?e[n].join("||"):""}return t})).join("||")})).join("::")+"]]",ready:!1}})),{result:"",ready:!1}}))},stylizing:function(t,e){return void 0===e&&(e=new Q),function(r){r.register(t,(function(t){var r=t.values;return e.stylize(r)}))}}},tt={tagsFull:"{{Tags}}",card:"{{Card}}",tags:"{{Tags}}".split(" ")},et=Object.freeze({__proto__:null,preset:tt,memorySwitch:function(t){var e=null;return{switchTo:function(r){t.getItem(r)||t.setItem(r,new Map),e=t.getItem(r)},fallback:function(){e=new Map},has:function(t){return e.has(t)},get:function(t){return e.get(t)},set:function(t,r){return e.set(t,r)},delete:function(t){return e.delete(t)},clear:function(){return e.clear()}}}}),rt=function(t,e){return t<0?e+t:t},nt=function(t){if("string"==typeof t)return t;switch(t.nodeType){case Node.TEXT_NODE:return t.textContent;case Node.ELEMENT_NODE:return t.innerHTML;case it.CHILD_NODE_SPAN:return t.spanAsStrings().join("");default:return""}},ot=function(t,e){if("string"!=typeof t)switch(t.nodeType){case Node.TEXT_NODE:var r=t,n=document.createElement("div");r.parentElement.insertBefore(n,r),r.parentElement.removeChild(r),n.outerHTML=e;break;case Node.ELEMENT_NODE:t.innerHTML=e;break;case it.CHILD_NODE_SPAN:t.replaceSpan(e)}},it=function(){function t(e,r,n){var o,i,s,a;this.nodeType=t.CHILD_NODE_SPAN,this.parentElement=e,this.childNodes=Array.from(this.parentElement.childNodes),this.max=e.childNodes.length-1;var u=this.getFromMethod(r.type),l=this.getToMethod(n.type);this._fromIndex=u.call(this,r.value,null!==(o=r.startAtIndex)&&void 0!==o?o:0,null!==(i=r.exclusive)&&void 0!==i&&i),this._toIndex=l.call(this,n.value,null!==(s=n.startAtIndex)&&void 0!==s?s:0,null!==(a=n.exclusive)&&void 0!==a&&a)}return Object.defineProperty(t.prototype,"from",{get:function(){return this._fromIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"to",{get:function(){return this._toIndex},enumerable:!1,configurable:!0}),t.prototype.getFromMethod=function(t){return"index"===t?this.fromIndex:"node"===t?this.fromNode:this.fromPredicate},t.prototype.getToMethod=function(t){return"index"===t?this.toIndex:"node"===t?this.toNode:this.toPredicate},t.prototype.fromSafe=function(t,e){return t<e||t>this.max?this.max:t},t.prototype.fromIndex=function(t,e,r){var n=rt(t,this.max)+(r?1:0);return this.fromSafe(n,e)},t.prototype.fromPredicate=function(t,e,r){var n=this.childNodes.slice(e).findIndex(t)+(r?1:0);return this.fromSafe(n,e)},t.prototype.fromNode=function(t,e,r){var n=this.childNodes.slice(e).findIndex((function(e){return e===t}))+(r?1:0);return this.fromSafe(n,e)},t.prototype.toSafe=function(t,e){return t<e||t>this.max?0:t},t.prototype.toIndex=function(t,e,r){var n=rt(t,this.max)-(r?1:0);return this.toSafe(n,e)},t.prototype.toPredicate=function(t,e,r){var n=this.childNodes.findIndex(t)-(r?1:0);return this.toSafe(n,e)},t.prototype.toNode=function(t,e,r){var n=this.childNodes.slice(e).findIndex((function(e){return e===t}))-(r?1:0);return this.toSafe(n,e)},t.prototype.isValid=function(){return this._fromIndex<=this._toIndex},t.prototype.length=function(){return Math.max(0,this._toIndex-this._fromIndex+1)},t.prototype.span=function(){return this.isValid()?this.childNodes.slice(this._fromIndex,this._toIndex):[]},t.prototype.spanAsStrings=function(){return this.span().map(nt)},t.prototype.replaceSpan=function(t){var e,n;if(this.isValid()){var o=document.createElement("div"),i=this.parentElement.childNodes.length;this.parentElement.insertBefore(o,this.parentElement.childNodes[this._fromIndex]);try{for(var s=r(this.span()),a=s.next();!a.done;a=s.next()){var u=a.value;this.parentElement.removeChild(u)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}o.outerHTML=t,this.childNodes=Array.from(this.parentElement.childNodes),this.max=this.childNodes.length,this._toIndex=this._toIndex+(this.max-i)}},t.CHILD_NODE_SPAN=3353,t}(),st=Object.freeze({__proto__:null,ChildNodeSpan:it,interspliceChildren:function(t,e){for(var r=new it(t,e,e);;){var n=e;n.startAtIndex=r.to;new it(t,n,n)}return[]},renderTemplateFromNode:function(t,e){var r=_(nt(t),e);ot(t,r)},renderTemplateFromNodes:function(t,e){var r=N(t.map(nt),e);t.forEach((function(t,e){return ot(t,r[e])}))}});return t.FilterManager=K,t.Stylizer=Q,t.anki=et,t.browser=st,t.recipes=Y,t.renderDisjointTemplate=N,t.renderTemplate=_,t}({});
